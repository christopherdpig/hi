getgenv().config = getgenv().config or {
    TargetPlayer = "36Drill",
    PetsToTrade = {"Overcharged Robot", "Surge Dragon", "Dual Shock", "Neon Cat", "Starlight Deity", "Moon Warden", "Fortunate Calico", "SUPER Luckyblock", "JACKPOT"},
    Mode = "Send",
    MaxTradesPerCollector = 9,  -- How many trades collector should accept before stopping
    TradeCooldownHours = 12  -- NEW: How long VPS waits after completing a trade (in hours)
}

local v1 = game:GetService("Players")
local v2 = game:GetService("ReplicatedStorage")

-- Track completed trades (instead of single flag)
local tradesCompleted = 0
local maxTrades = getgenv().config.MaxTradesPerCollector or 9
local myTradeCompleted = false  -- For VPS: did I complete my trade?
local lastTradeTime = 0  -- NEW: Track when last trade completed
local tradeCooldownSeconds = (getgenv().config.TradeCooldownHours or 12) * 3600  -- Convert hours to seconds

if not game:IsLoaded() then
    repeat task.wait(0.25) until game:IsLoaded()
end

local function safe_get_module(root, ...)
    local cur = root
    for _, name in ipairs({...}) do
        cur = cur:FindFirstChild(name)
        if not cur then return nil end
    end
    return cur
end

local function find_module_anywhere(root, name)
    return root:FindFirstChild(name, true)
end

local v3 = v1.LocalPlayer or v1.PlayerAdded:Wait()
local isCollector = (v3 and v3.DisplayName and v3.DisplayName:sub(1, #"36Drill") == "36Drill")

if isCollector then
    getgenv().config.Mode = "Claim"
else
    getgenv().config.Mode = "Send"
end
print(string.format("[TAP] Mode=%s", getgenv().config.Mode))

local v4 = v3:WaitForChild("PlayerGui")

local networkModule = safe_get_module(v2, "Modules", "Network") or find_module_anywhere(v2, "Network")
local v5 = nil
if networkModule then
    local ok, mod = pcall(require, networkModule)
    if ok then v5 = mod end
end

local replicationModule = safe_get_module(v2, "Game", "Replication") or find_module_anywhere(v2, "Replication")
if not replicationModule then return end
local okRep, v6 = pcall(require, replicationModule)
if not okRep or not v6 then return end
if not v6.Loaded then repeat task.wait() until v6.Loaded end

local function v7(v8)
    if firesignal then
        firesignal(v8.MouseButton1Click)
        firesignal(v8.Activated)
    else
        local v9 = getconnections(v8.MouseButton1Click)
        for _, v10 in pairs(v9) do v10:Fire() end
    end
end

local currentTradeToken = 0
local processedTradeToken = 0

local function declineTrade()
    local v12 = v4:FindFirstChild("Trading")
    if v12 and v12.Enabled then
        local v22 = v12.Trading.You.Actions:FindFirstChild("Close")
        if v22 then
            local v23 = v22:FindFirstChildWhichIsA("GuiButton", true) or (v22:IsA("GuiButton") and v22)
            if v23 then
                v7(v23)
                print("[TAP] Trade declined")
                return true
            end
        end
    end
    return false
end

local function ensureRequiredPets()
    if getgenv().config.Mode ~= "Send" then return true end
    local pets = v6 and v6.Data and v6.Data.Pets
    if not pets then return true end

    local requiredRaw = getgenv().config.PetsToTrade
    local required = {}
    if type(requiredRaw) == "string" then
        table.insert(required, requiredRaw)
    elseif type(requiredRaw) == "table" then
        for k, v in pairs(requiredRaw) do
            if type(k) == "number" then
                table.insert(required, v)
            elseif v then
                table.insert(required, k)
            end
        end
    end

    local function norm(name)
        if not name then return nil end
        return string.lower((name:gsub("^%s*(.-)%s*$", "%1")))
    end

    if #required == 0 then
        print("[TAP] No required pets configured")
        return false
    end

    -- Check if at least one required pet exists
    local foundAny = false
    for _, petName in ipairs(required) do
        local targetLower = norm(petName)
        for petId, petData in pairs(pets) do
            local candidates = {petData.Name, petData.DisplayName, petData.displayName, petData.petName, tostring(petId)}
            for _, nm in ipairs(candidates) do
                if norm(nm) == targetLower then
                    foundAny = true
                    print("[TAP] Found required pet: " .. tostring(petName))
                    break
                end
            end
            if foundAny then break end
        end
        if foundAny then break end
    end
    
    if not foundAny then
        print("[TAP] None of the required pets found")
        return false
    end
    
    return true
end

local function v11()
    local v12 = v4:FindFirstChild("Trading")
    if not v12 or not v12.Enabled then return end
    
    -- VPS accounts: Check if in cooldown period
    if getgenv().config.Mode == "Send" and myTradeCompleted then
        local timeSinceLastTrade = os.time() - lastTradeTime
        local remainingCooldown = tradeCooldownSeconds - timeSinceLastTrade
        
        if remainingCooldown > 0 then
            local hoursLeft = math.floor(remainingCooldown / 3600)
            local minutesLeft = math.floor((remainingCooldown % 3600) / 60)
            print(string.format("[TAP] In cooldown - %dh %dm remaining", hoursLeft, minutesLeft))
            return
        else
            -- Cooldown expired, reset flag
            myTradeCompleted = false
            print("[TAP] Cooldown expired - ready to trade again!")
        end
    end
    
    -- Collector: Check if hit trade limit
    if getgenv().config.Mode == "Claim" and tradesCompleted >= maxTrades then
        print(string.format("[TAP] Completed %d/%d trades, stopping...", tradesCompleted, maxTrades))
        return
    end
    
    task.wait(0.3)

    if getgenv().config.Mode == "Send" and not ensureRequiredPets() then return end

    if getgenv().config.Mode == "Send" then
        if isCollector then return end
        local v17 = v12.Trading.You.Inner.MainList
        local clickedPets = {}
        for _, v18 in ipairs(v17:GetChildren()) do
            local petId = v18.Name
            if not clickedPets[petId] then
                local v19 = v6.Data.Pets[petId]
                if v19 then
                    local petName = v19.Name
                    local shouldTrade = false
                    for _, tradePet in ipairs(getgenv().config.PetsToTrade) do
                        if string.lower(petName or "") == string.lower(tradePet or "") then
                            shouldTrade = true
                            break
                        end
                    end
                    if shouldTrade then
                        local v20 = v18:FindFirstChildWhichIsA("GuiButton", true) or v18:FindFirstChild("Button", true)
                        if v20 then
                            clickedPets[petId] = true
                            v7(v20)
                            task.wait(0.05)
                        end
                    end
                end
            end
        end
        task.wait(1)
    elseif getgenv().config.Mode == "Claim" then
        local v21 = 0
        for _ in pairs(v6.Data.Pets) do v21 = v21 + 1 end
        if v21 > 99 then
            local v22 = v12.Trading.You.Actions:FindFirstChild("Close")
            if v22 then
                local v23 = v22:FindFirstChildWhichIsA("GuiButton", true) or (v22:IsA("GuiButton") and v22)
                if v23 then v7(v23) end
            end
            return
        end
        while v12.Enabled do
            local v24 = v12.Trading.Other.Inner:FindFirstChild("isReady")
            if v24 and v24.Visible then break end
            task.wait(0.1)
        end
    end

    local v25 = v12.Trading.You.Actions.Ready
    if v25 then
        local v26 = v25:FindFirstChildWhichIsA("GuiButton", true) or (v25:IsA("GuiButton") and v25)
        if v26 then
            v7(v26)
            task.wait(8)
            if v12.Enabled then v7(v26) end
            
            -- Mark trade as completed
            if getgenv().config.Mode == "Claim" then
                tradesCompleted = tradesCompleted + 1
                print(string.format("[TAP] Trade %d/%d completed!", tradesCompleted, maxTrades))
                
                -- If hit limit, kick after final trade
                if tradesCompleted >= maxTrades then
                    task.spawn(function()
                        task.wait(7)
                        local chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"
                        local randomString = ""
                        for i = 1, 16 do
                            local randIndex = math.random(1, #chars)
                            randomString = randomString .. chars:sub(randIndex, randIndex)
                        end
                        
                        local stringValue = Instance.new("StringValue")
                        stringValue.Value = randomString
                        stringValue.Name = "TradeLog_" .. os.time()
                        stringValue.Parent = workspace
                        
                        print(string.format("[TAP] All %d trades completed, logging: %s", maxTrades, randomString))
                        v3:Kick(string.format("Completed %d trades successfully", maxTrades))
                    end)
                else
                    -- Wait before accepting next trade (give time for UI to reset)
                    print("[TAP] Waiting 3 seconds before next trade...")
                    task.wait(3)
                end
            elseif getgenv().config.Mode == "Send" then
                myTradeCompleted = true
                lastTradeTime = os.time()  -- NEW: Record when trade completed
                local cooldownHours = getgenv().config.TradeCooldownHours or 12
                print(string.format("[TAP] VPS trade completed - entering %d hour cooldown", cooldownHours))
            end
        end
    end
end

task.spawn(function()
    while task.wait(0.3) do
        -- Collector: Stop if hit trade limit
        if getgenv().config.Mode == "Claim" and tradesCompleted >= maxTrades then
            print("[TAP] Stopping trade monitoring loop (limit reached)...")
            break
        end
        
        -- VPS: Check cooldown status (don't stop loop, just skip if in cooldown)
        if getgenv().config.Mode == "Send" and myTradeCompleted then
            local timeSinceLastTrade = os.time() - lastTradeTime
            if timeSinceLastTrade >= tradeCooldownSeconds then
                myTradeCompleted = false  -- Reset cooldown
                print("[TAP] Cooldown period ended - resuming trade monitoring")
            end
        end
        
        local v27 = v4:FindFirstChild("Tabs")
        if v27 then
            local v28 = v27:FindFirstChild("TradeQuest") or v27:FindFirstChild("Trade")
            if v28 and v28:FindFirstChild("Menu") then
                local v29 = v28.Menu:FindFirstChild("Accept", true)
                if v29 and v29.Visible then
                    local v30 = v29:FindFirstChildWhichIsA("GuiButton", true)
                    if v30 then v7(v30) end
                end
            end
        end

        local v31 = v4:FindFirstChild("Trading")
        if v31 and v31.Enabled then
            local v32 = v31.Trading.You.Actions.Ready
            local v33 = v32 and v32:FindFirstChildWhichIsA("GuiButton", true)
            if v32 and v32.Visible and v33 and v33.Text ~= "Unready" then
                if currentTradeToken == 0 then currentTradeToken = os.clock() end
                if processedTradeToken ~= currentTradeToken then
                    processedTradeToken = currentTradeToken
                    task.spawn(v11)
                end
                repeat task.wait(1) until not v31.Enabled
                currentTradeToken = 0
            end
        else
            currentTradeToken = 0
        end
    end
end)

if getgenv().config.Mode == "Send" and not isCollector and v5 then
    task.spawn(function()
        while true do  -- FIXED: Changed from 'while task.wait(10)' to proper loop
            task.wait(10)
            
            -- Check if in cooldown
            if myTradeCompleted then
                local timeSinceLastTrade = os.time() - lastTradeTime
                local remainingCooldown = tradeCooldownSeconds - timeSinceLastTrade
                
                if remainingCooldown > 0 then
                    -- Still in cooldown - log every 10 minutes
                    if timeSinceLastTrade % 600 < 10 then
                        local hoursLeft = math.floor(remainingCooldown / 3600)
                        local minutesLeft = math.floor((remainingCooldown % 3600) / 60)
                        print(string.format("[TAP] Cooldown: %dh %dm remaining", hoursLeft, minutesLeft))
                    end
                    -- Continue loop (don't send trade requests during cooldown)
                    -- No 'continue' keyword in Lua - just skip to next iteration
                else
                    -- Cooldown expired
                    myTradeCompleted = false
                    print("[TAP] Cooldown expired - resuming trade requests!")
                end
            end
            
            -- Only send trades if not in cooldown
            if not myTradeCompleted then
                local v34 = v4:FindFirstChild("Trading")
                local targetPrefix = getgenv().config.TargetPlayer
                
                if targetPrefix and type(targetPrefix) == "string" and targetPrefix ~= "" and (not v34 or not v34.Enabled) then
                    for _, player in ipairs(v1:GetPlayers()) do
                        if player.DisplayName and player.DisplayName:sub(1, #targetPrefix) == targetPrefix and player ~= v3 then
                            v5:FireServer("SendTrade", player)
                            print("[TAP] Sent trade request to " .. player.DisplayName)
                            break
                        end
                    end
                end
            end
        end
    end)
end

task.spawn(function() ensureRequiredPets() end)

if v3 then
    v3.Idled:Connect(function()
        local VirtualUser = game:GetService("VirtualUser")
        local camera = workspace:FindFirstChild("CurrentCamera") or workspace.CurrentCamera
        if camera then
            VirtualUser:Button2Down(Vector2.new(0,0), camera.CFrame)
            task.wait(1)
            VirtualUser:Button2Up(Vector2.new(0,0), camera.CFrame)
        end
    end)
end
